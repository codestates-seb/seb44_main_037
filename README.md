# 🙌 GoodsHub
`#굿즈` `#중고거래` `#경매 `
<div align="center">
  <img src="https://github.com/codestates-seb/seb44_main_037/assets/124581006/63390e47-4b57-4c13-bce8-16350b9d6f1a.png" width="700" />
</div>

## 💡 프로젝트 동기
절판된 물건을 구하기 위해 중고 거래 사이트를 돌아다닌 경험이 있으신가요?<br/>
판매자에게 희망 가격을 제시했다가 더 높은 가격을 제시한 구매자가 있다며 거절당한 적은요?<br/><br/>
굿즈헙은 일 년이 넘도록 중고 거래 플랫폼을 모니터링하고 있음에도 원하는 물건을 손에 넣지 못한 한을 담아 만든 서비스입니다. 경매 기능을 지원하는 것은 물론 그 내용이 투명하게 공개되기 때문에 판매자는 높은 수익을 창출할 수 있고, 구매자는 자유롭게 경쟁할 수 있습니다.

<br/>

## 📜 목차

1. [💡 프로젝트 동기](#-프로젝트-동기)
2. [🪃 기술스택](#-기술스택)
3. [🛠 기능 엿보기](#-기능-엿보기)
4. [🙋‍♀️ 기술적 도전](#-기술적-도전)
5. [🎞️ 마무리하며](#-마무리하며)

<br>

## 🪃 기술스택
### Client
- React
- React Router
- Redux
- Styled-Components
- socket.io

### Server
- Node.js
- Express
- MongoDB
- Mongoose
- socket.io

### Other
- AWS S3
- eslint
- prettier

<br/>

## 🛠 기능 엿보기
### 1. 유저 프로필 및 상품 이미지 첨부·저장
![회원가입](https://github.com/codestates-seb/seb44_main_037/assets/124581006/962443aa-657b-4540-8b57-5ece735692c5)

- 첨부한 이미지를 바로 확인할 수 있도록 `FileReader` 객체 활용
- 클라이언트가 보낸 이미지 파일을 서버에서 받아 활용할 수 있도록 `FormData`와 `multer` 활용
- DB 성능 저하를 막기 위해 이미지는 AWS S3에 저장하고, DB에는 해당 이미지의 경로를 저장

### 2. 경매 기능
![실시간 입찰 히스토리](https://github.com/codestates-seb/seb44_main_037/assets/124581006/9026fa7f-fda7-48a2-8ed1-3a1c585d61e7)

- 실시간 입찰 내역 업데이트
- 서버 시간
  - 실시간 입찰 현황 아래 초단위로 시간 표시
  - 경매에 참여하는 모든 클라이언트가 같은 시각을 공유하도록 SSE를 통한 서버시각 전송
- 경매 성사 시 데이터 변경 처리
  - node cron을 이용하여 마감 시각에 맞춰 최고 입찰자와 판매자의 포인트를 구매액/판매액만큼 증감

### 3. 채팅 기능
![채팅](https://github.com/codestates-seb/seb44_main_037/assets/124581006/a6d97f1d-52d8-46f5-b7a7-d2cffe1e30b7)

- 거래 성사 시 자동으로 채팅방 생성
- Socket.IO를 활용하여 메시지를 보내는 즉시 상대방이 내용을 확인할 수 있도록 처리

### 4. 포인트 충전 결제
![충전 영상](https://github.com/codestates-seb/seb44_main_037/assets/124581006/8a34b1d4-34ee-4fd2-888e-b509d321248c)

- 토스 페이먼츠 모듈을 활용하여 포인트 충전 기능 지원
- 판매가(일반 상품) 혹은 입찰가만큼의 포인트를 가지고 있지 않으면 거래가 진행되지 않도록 유효성 처리 및 사용자 알림

<br> 

## 🙋‍♀️ 기술적 도전

### 1. AWS S3를 이용한 이미지 업로드

본 프로젝트에는 <u>프로필 이미지와 상품 이미지를 첨부하는 기능</u>이 있습니다. <br> 두 기능은 다음과 같은 흐름으로 동작합니다. 
1. 사용자가 '완료' 버튼을 누르면 클라이언트에서 서버로 이미지를 전달
2. 서버가 이를 받아 S3 버킷에 이미지를 저장
3. 그 주소를 DB에 저장

초기에는 현재와 달리 사용자가 이미지를 첨부할 때마다 **클라이언트에서 S3 버킷에 이미지를 저장**하고, 저장된 이미지 파일의 주소를 서버로 전달하는 형식으로 만들었습니다. S3 이미지 업로드를 가장 간단하게 구현하는 방법이었기 때문입니다. 그러나 기능을 구현하고 보니 버킷을 비롯한 자원이 **낭비**되고 있다는 생각이 들었습니다. 사용자가 해당 이미지를 사용하겠다고 완전히 결정한 것도 아닌데, 이미지를 바꿀 때마다 버킷에 파일이 업로드 되었기 때문입니다.<br><br>
이를 해결하기 위해 서버가 클라이언트로부터 이미지 파일 자체를 받는 지금의 방식으로 변경했습니다. 이제 사용자가 프로필 이미지를 100번 첨부하더라도 최종적으로 '완료' 버튼을 누를 때 **한 번만** 이미지가 저장됩니다. 구현 방식이 훨씬 어렵고 복잡했지만 전자에 비해 S3 비용을 크게 절약할 수 있기에 좋은 결정이었다고 생각합니다.

🔗 **블로그 기록** | [**AWS S3 버킷에 두 번 지고 깨달은 것**](https://miyammy.tistory.com/20)

<br>

### 2. 실시간으로 입찰 내역 업데이트하기 & 메시지 주고받기
Socket IO를 활용하여 **실시간 입찰**과 **채팅** 기능을 구현했습니다.
굿즈헙에서는 특정 판매글을 보고 있는 모든 유저에게 실시간 경매 내역이 제공됩니다. 같은 원리로 특정 채팅방에 접속한 모든 유저가 실시간으로 서로의 메시지를 확인할 수 있습니다. 지금까지는 응답을 받기 위해 의도된 요청(예: 메인 페이지 렌더링 시 서버로부터 프로젝트 데이터 받기)을 보내는 작업만 해보았기에, 언제 업데이트 될지 알 수 없는 데이터를 실시간으로 받아와야 한다는 점이 어려웠습니다. 구현 방법을 고민하다 실시간 데이터 양방향 전송을 지원하는 Socket IO를 사용했습니다.

많은 시행착오 중에서도 기억에 남는 것은 룸 아이디의 전달 방식입니다. 사용자가 채팅방에 접속하거나 특정 상품 페이지로 들어오면 고유한 룸 아이디에 따라 join이 일어나야 합니다. 다시 말해, 서버는 접속자가 생길 때마다 그가 **어떤 룸 아이디를 가지고 있는지 인식**할 수 있어야 합니다. 처음에는 리액트 라우터를 사용할 때 path를 추출하듯이 네임스페이스 뒤에 룸 아이디를 붙이려고 했습니다.

```js
const socket = io(`${URL}/auction/${roomId}`, ... );
```
하지만 이 방식은 변수명이 roomId일 뿐 무수히 많은 네임스페이스를 만들어내는 것과 다름없었습니다. 서버에서는 URL 뒷 부분을 모두 네임스페이스로 판단하기 때문입니다.

다른 방법을 찾기 위해 공식 문서를 살펴보던 중 [Handling CORS 챕터](https://socket.io/docs/v4/handling-cors/)에서  **사용자 정의 헤더**를 사용할 수도 있겠다는 영감을 얻었습니다. 이렇게 하니 헤더에서 바로 룸 아이디를 추출하여 아주 간단하게 join을 처리할 수 있었습니다.

🔗 **블로그 기록** | [**Socket IO를 처음 활용하며 고민한 것들**](https://miyammy.tistory.com/22)

<br>

### 3. 경매 마감 처리를 위한 노드 스케쥴링

경매 마감 시 판매 상태를 ‘판매 완료’로 수정하고, 판매자와 낙찰자의 포인트를 증감시킵니다. 이를 위해 `node-schedule`을 사용하여 특정 시간이 되면 서버에서 자동으로 함수를 실행하도록 만들었습니다.

상품 등록 요청이 들어오면 상품 정보가 DB에 저장되고, 서버는 요청에 포함된 경매 마감 시각에 함수가 실행되도록 스케쥴을 설정합니다. 이후 시간이 되면 서버는 상품의 판매 상태를 변경하고, 이 거래와 관련된 유저들의 데이터 또한 수정합니다.

<br>

## 🎞️ 프로젝트를 마친 소감

> 해낼 수 있을까? <br>가능했다!
- 처음에는 간단한 경매 서비스를 구상했는데 사용자의 입장에서 반드시 필요한 기능을 고려하다 보니 프로젝트의 사이즈가 커졌습니다. 여기에 이전 프로젝트와 달리 혼자서 백엔드와 프론트엔드를 모두 다루어야 한다는 점, 타입스크립트라는 미지의 언어, 처음 접한 기능이나 개념들이 더해져 굉장히 도전적인 한 달이 아니었나 합니다.
- 한 가지 아쉬운 점은 일정에 여유가 없어 '더 나은 방향으로 작성할 수는 없었을까?'라는 생각이 들게 만드는 코드를 남겼다는 것입니다. 이 부분은 타입스크립트와 리팩토링을 공부하며 차근차근 개선해나가야겠습니다.
- 심적으로 고생이 많았던 만큼 얻은 점이 많았습니다. 특히 어려워 보이는 것이라도 포기하지 않으면 해낼 수 있다는 자신감을 얻었습니다. 에러를 두려워하지 않게 되었다는 것 또한 큰 소득이었습니다. 앞으로도 도전을 두려워하지 않는 개발자가 되기 위해 노력해야겠습니다.
   
<br>
